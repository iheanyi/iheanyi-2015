<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no,minimal-ui" />
    <meta name="description" content="The portfolio and blog of Iheanyi Ekechukwu, a Software Developer and Designer.">
    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />

    <link rel="shortcut icon" type="image/ico" href="favicon.ico" />


    <!-- Use title if it's in the page YAML frontmatter -->
    <title>User Registration with Ember.js, Rails, and Devise</title>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,900|Gentium+Basic:400,700,400italic' rel='stylesheet' type='text/css'>

    <link href="../../stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="../../stylesheets/all.css" rel="stylesheet" type="text/css" />
    <script src="../../javascripts/all.js" type="text/javascript"></script>

  </head>

  <body class="blog blog_user-registration-and-authentication-with-emberjs-rails-and-devise blog_user-registration-and-authentication-with-emberjs-rails-and-devise_index">
    <div id="wrapper">
      <div id="navigation-header" class="navigation no-background">
  <div id="navigation-area" class="">
    <div id="branding-area" class="branding pad-left">
      <a class="branding-logo" href="../../">Iheanyi Ekechukwu</a>
    </div>

    <nav class="nav-collapse">
        <ul class="navigation-items">
            <li class="" ><a href="../../about/">About</a></li>
            <li class=""  ><a href="../../projects/">Projects</a></li>
            <li class="selected"><a href="../">Writing</a></li>
            <li class=""><a relative=="true" href="../../contact/">Contact</a></li>
        </ul>
    </nav>
  </div>
</div>


        <div class="post-container">
    <div class="container">

      <div class="post-content-area">
        <div class="row post-heading">
          <span class="post-title actual-post-title">User Registration with Ember.js, Rails, and Devise</span>
         <span class="post-date">December 24, 2015</span>

        </div>
        <div class="row post-content">
            <p>In this tutorial, we will be creating an Ember application with user authentication and registration using a Ruby on Rails back-end with the <a href="https://github.com/plataformatec/devise">Devise</a> gem.</p>

<h4>Getting Setup</h4>

<p>Before we begin developing, make sure that you have the following tools installed on your machine. </p>

<ul>
<li>  Ruby 2.2.0</li>
<li>  Rails 4.2.0</li>
<li>  Node 0.10.35</li>
<li>  npm 2.2</li>
<li>  Ember-CLI 0.1.12</li>
<li>  Postgres (for deploying to Heroku)</li>
</ul>

<p>For this tutorial, versions at or above the following should suffice. For installing these tools, please refer elsewhere on the web.</p>

<p>Next, we will install <code>ember-cli</code>.</p>
<pre class="highlight shell"><code>npm install -g ember-cli
</code></pre>

<p>Confirm that ember is installed by running <code>ember --version</code>. You should see <code>version: 0.1.12</code> or higher.</p>

<h5>Creating the Rails and Ember Apps</h5>

<p>Change into the desired directory for your new project and then create the directory that will house our Rails and EmberJS applications.</p>
<pre class="highlight plaintext"><code>mkdir ember_rails_auth
cd ember_rails_auth
</code></pre>

<p>Next, create an rvm gemset so we can sandbox our gem dependencies.</p>
<pre class="highlight plaintext"><code>rvm gemset create ember_rails_auth
rvm gemset use ember_rails_auth
gem install rails
</code></pre>

<p>After that finishes, create a new Rails project, then rename it.</p>
<pre class="highlight plaintext"><code>rails new ember_rails_auth -B -S -d postgresql
mv ember_rails_auth rails
</code></pre>

<p>And then the Ember project.</p>
<pre class="highlight plaintext"><code>ember new ember_rails auth
mv ember_rails_auth ember
</code></pre>

<p>Your directory should now look like this.</p>
<pre class="highlight plaintext"><code>ember_rails_auth
├── ember
└── rails
</code></pre>

<p>Confirm that the EmberJS app was successfully creatd:</p>
<pre class="highlight plaintext"><code>cd ember
ember server    
</code></pre>

<p>If you visit <code>http://localhost:4200</code> and see &ldquo;Welcome to Ember.js&rdquo;, you&rsquo;re good to go!</p>

<p>Change back into the <code>ember_rails_auth</code> directory, so we can make some modifications to our Rails application.</p>
<pre class="highlight plaintext"><code>rm -rf rails/app/assets
</code></pre>

<p>Also, remove the following from <code>rails/Gemfile</code>:</p>

<ul>
<li>coffee-rails</li>
<li>jquery-rails</li>
<li>turbolinks</li>
<li>jbuilder</li>
</ul>

<p>By making these modifications, we&rsquo;ve removed the Asset Pipeline from our Rails application.</p>

<p>Let&rsquo;s change into the Rails directory and add some gems that will save us some time to our <code>Gemfile</code>.</p>
<pre class="highlight ruby"><code><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'guard'</span>
  <span class="n">gem</span>  <span class="s1">'guard-rails'</span>
  <span class="n">gem</span>  <span class="s1">'guard-bundler'</span>
<span class="k">end</span>
</code></pre>

<p>Then let&rsquo;s install and add them by running the following commands:</p>
<pre class="highlight plaintext"><code>bundle install
bundle exec guard init
</code></pre>

<p>By installing Guard, Guard Rails, and Guard Bundler, this does two things. First, whenever we make changes to any files within our Rails application, the server will automatically refresh to show these changes. Secondly, whenever we add new dependencies to our Gemfile, it will automatically execute &ldquo;bundle install&rdquo; and restart the server.</p>

<p>With everything installed, lets first start out by building out the  main functionality for our Rails back-end application for our application.</p>

<h4>Building the Rails Back-End</h4>

<p>While I won&rsquo;t necessarily go full-out TDD for the purposes of this tutorial, we will be using <a href="#">rspec</a> to write our tests. Open your <code>Gemfile</code> and add <code>rspec-rails</code>:</p>
<pre class="highlight plaintext"><code>...
group :development, :test do
  ...
  gem 'rspec-rails'
end
</code></pre>

<p>Now let&rsquo;s install <code>rspec</code>:</p>
<pre class="highlight plaintext"><code>bundle install
rails generate rspec:install
</code></pre>

<p>Before we begin building our API, let&rsquo;s add the following to our Gemfile.</p>
<pre class="highlight plaintext"><code># rails/Gemfile

gem 'active_model_serializers', '0.8.3'
</code></pre>

<p>If you are using Rails 4.2.0, you must use version 0.8.3 of the gem. Make sure you run <code>bundle install</code> and install it. </p>

<h5>User Registration</h5>

<p>Add the following to your Gemfile:</p>
<pre class="highlight plaintext"><code>gem 'devise'
</code></pre>

<p>Run the <code>bundle</code> command to install it, then run the Devise generator:</p>
<pre class="highlight plaintext"><code>rails generate devise:install
</code></pre>

<p>Make sure the database is created by running the following:</p>
<pre class="highlight plaintext"><code>rake db:create
</code></pre>

<p>Then we can generate our <code>User</code> model by executing the following commands: </p>
<pre class="highlight plaintext"><code>rails generate devise User
rake db:migrate
</code></pre>

<p>Next, we&rsquo;re going to add an authentication token to our <code>User</code> model.</p>
<pre class="highlight plaintext"><code>rails g migration AddAuthenticationTokenToUser authentication_token:string
rake db:migrate
</code></pre>

<p>This authentication token will be generated whenever the User is created and returned on login back to the user.</p>

<p>Before each new User is saved, we must ensure that the authentication token exists. Open <code>models/user.rb</code> and add the following lines to the model, below the devise modules:</p>
<pre class="highlight ruby"><code>
<span class="n">before_save</span> <span class="ss">:ensure_authentication_token</span>

<span class="k">def</span> <span class="nf">ensure_authentication_token</span>
    <span class="k">if</span> <span class="n">authentication_token</span><span class="p">.</span><span class="nf">blank?</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">authentication_token</span> <span class="o">=</span> <span class="n">generate_authentication_token</span>
    <span class="k">end</span>
<span class="k">end</span>


<span class="kp">private</span>
 <span class="k">def</span> <span class="nf">generate_authentication_token</span>
   <span class="kp">loop</span> <span class="k">do</span>
     <span class="n">token</span> <span class="o">=</span> <span class="no">Devise</span><span class="p">.</span><span class="nf">friendly_token</span>
     <span class="k">break</span> <span class="n">token</span> <span class="k">unless</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">authentication_token: </span><span class="n">token</span><span class="p">).</span><span class="nf">first</span>
   <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>In the end, your <code>models/user.rb</code> file should look like this:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :confirmable, :lockable, :timeoutable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>


  <span class="n">before_save</span> <span class="ss">:ensure_authentication_token</span>

  <span class="k">def</span> <span class="nf">ensure_authentication_token</span>
    <span class="k">if</span> <span class="n">authentication_token</span><span class="p">.</span><span class="nf">blank?</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">authentication_token</span> <span class="o">=</span> <span class="n">generate_authentication_token</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">generate_authentication_token</span>
      <span class="kp">loop</span> <span class="k">do</span>
        <span class="n">token</span> <span class="o">=</span> <span class="no">Devise</span><span class="p">.</span><span class="nf">friendly_token</span>
        <span class="k">break</span> <span class="n">token</span> <span class="k">unless</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">authentication_token: </span><span class="n">token</span><span class="p">).</span><span class="nf">first</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>What we are doing here is ensuring that whenever a new user is created (meaning registered), we would like to create a unique authentication token for them before they are saved into the database, handled by <code>before_save :ensure_authentication_token</code> callback. The <code>ensure_authentication_token</code> method will generate an authentication token if the user&rsquo;s authentication token does not exist.  The <code>generate_authentication_token</code> method generates a unique authentication token for the user.</p>

<p>Before we start creating the registration, we need to create a serializer for the <code>User</code>. We can do that with the following command:</p>
<pre class="highlight plaintext"><code>rails g serializer user
</code></pre>

<p>Open <code>app/serializers/user_serializer.rb</code> and modify the attributes line to the following:</p>
<pre class="highlight plaintext"><code># app/serializers/user_serializer.rb

attributes :id, :email
</code></pre>

<p>Next, we will need to override the Devise registration and sessions controllers. Copy Devise controllers to your app by running the following command:</p>
<pre class="highlight plaintext"><code>rails generate devise:controllers api/users
</code></pre>

<p>This will create a <code>users/</code> directory in <code>app/controllers/api</code>.</p>

<p>Open <code>config/routes.rb</code> and modify the line <code>devise_for :users</code> to the following:</p>
<pre class="highlight plaintext"><code>devise_for :users, path: 'api/users', controllers: { sessions: "api/users/sessions", registrations: "api/users/registrations" }
</code></pre>

<p>This makes the Devise routes map to the <code>api</code> URL namespace, as namespace nesting for Devise is broken.</p>

<p>Next, open <code>app/controllers/users/registrations_controller.rb</code> and modify the <code>create</code> method to the following:</p>
<pre class="highlight ruby"><code>
<span class="n">skip_before_filter</span> <span class="ss">:verify_authenticity_token</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:create</span>

<span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">sign_in</span> <span class="vi">@user</span>
    <span class="n">json</span> <span class="o">=</span> <span class="o">::</span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">).</span><span class="nf">as_json</span>
    <span class="n">json</span><span class="p">[</span><span class="ss">:user</span><span class="p">].</span><span class="nf">merge</span><span class="p">(</span><span class="ss">token: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">authentication_token</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="n">json</span><span class="p">,</span> <span class="ss">status: :created</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span><span class="ss">errors: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">to_json</span><span class="p">},</span> <span class="ss">status: :unauthorized</span>
  <span class="k">end</span>
</code></pre>

<p>We want to disable CSRF on <code>create</code> because we will be using an authentication token as the security measure.</p>

<p>Additionally, make sure you add the user parameters to the controller as well:</p>
<pre class="highlight ruby"><code><span class="kp">private</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre>

<p>To test the functionality of our registrations controller, let&rsquo;s create a spec for it.</p>
<pre class="highlight plaintext"><code>rails g rspec:controller api/users/registrations_controller
</code></pre>

<p>Before we start writing our tests, we need to make sure to add Devise to <code>spec/rails_helper.rb</code>. Open the file and add the following line:</p>

<p><code>config.include Devise::TestHelpers, type: :controller</code></p>

<p>Let&rsquo;s write our tests. Open the newly created file at <code>spec/controllers/api/users/registrations_controller_controller_spec.rb</code> and add the following lines of code.</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">RegistrationsController</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"devise.mapping"</span><span class="p">]</span> <span class="o">=</span> <span class="no">Devise</span><span class="p">.</span><span class="nf">mappings</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"POST users#sign_up"</span> <span class="k">do</span>

    <span class="n">context</span> <span class="s2">"valid user credentials"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">user: </span><span class="p">{</span><span class="ss">email: </span><span class="s2">"foo@bar.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"foofoobar"</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"creates the user"</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">created?</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">true</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"logs in the user"</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">nil?</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">false</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"user already created"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">email: </span><span class="s2">"foo@bar.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"foofoobar"</span><span class="p">)</span>

      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">user: </span><span class="p">{</span><span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">password</span><span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"does not create the user"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">unauthorized?</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should not log in the user"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">nil?</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>By running <code>rspec</code> from the CL, you should see four of the tests passing, with one pending from <code>user_spec.rb</code>. If you open the file and comment out the only line in its block, all the tests will now be passing.</p>

<p>From these tests, we are sending a POST request to the <code>users/registrations#create</code> method and ensuring that our controllers behave as expected. If there are valid credentials and email doesn&rsquo;t exist, we expect the user to be created and then signed in. Else, if the user already exists, then we should not create the user and not sign them in. </p>

<p>With that, we have our user registration feature working!</p>


            <hr>

            <div>
              <a href="https://twitter.com/share" class="twitter-share-button" data-via="kwuchu">Tweet</a>
              <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            </div>
        </div>
      </div>


    </div>
  </div>



    </div>



    <footer>
  <div class="container ">

    <div class="footer-left ">

          <div class="row copyright">
            Design & Code &copy; Iheanyi Ekechukwu 2015.
          </div>

          <div class="row footer-list">
            <ul class="social-media-list">
              <li class=""><a href="mailto:iekechukwu@gmail.com" class="ion-email"></a></li>
              <li class=""><a target="_blank" href="http://twitter.com/kwuchu" class="icon ion-social-twitter"></a></li>
              <li class=""><a target="_blank" href="http://github.com/iheanyi" class="icon ion-social-github"></a></li>
              <li class=""><a target="_blank" href="http://dribbble.com/iheanyi" class="icon ion-social-dribbble"></a></li>
              <li class=""><a target="_blank" href="http://linkedin.com/in/iheanyi" class="icon ion-social-linkedin"></a></li>
            </ul>
          </div>

    </div>

    <div class="footer-right ">
        <ul class="footer-navigation">
            <li><a href="../../about/">About</a></li>
            <li><a href="../../projects/">Projects</a></li>
            <li><a href="../">Writing</a></li>
            <li><a relative=="true" href="../../contact/">Contact</a></li>
        </ul>
    </div>
  </div>
</footer>


    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-36709787-8', 'auto');
  ga('send', 'pageview');
</script>

    <script>
      var navigationHeader = $("#navigation-header");
      var navArea = $("#navigation-area");
      var brandingArea = $("#branding-area");

      var nav = responsiveNav(".nav-collapse", {
        animate: false,
        label: "",
        open: function() {
          console.log("Open called!");
          navigationHeader.toggleClass("background-active");
          navArea.toggleClass("background-active");
          brandingArea.toggleClass("background-active");
          $('html, body').css({
              'overflow': 'hidden',
              'height': '100%'
          });
        },
        close: function() {
          console.log("Close called!");
          navigationHeader.toggleClass("background-active");
          navArea.toggleClass("background-active");
          brandingArea.toggleClass("background-active");
          $('html, body').css({
              'overflow': 'auto',
              'height': 'auto'
          });
        }
      });




      /*var open = document.getElementById("open");
      open.addEventListener("click", function(e) {
        e.preventDefault();
        nav.open();
        console.log("Open clicked!");
      }, false);

      var close = document.getElementById("close");
      close.addEventListener("click", function(e) {
        e.preventDefault();
        nav.close();
        console.log("Close clicked!");
      });*/
    </script>
  </body>
</html>